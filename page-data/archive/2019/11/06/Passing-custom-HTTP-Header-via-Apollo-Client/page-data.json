{"componentChunkName":"component---src-templates-post-js","path":"/archive/2019/11/06/Passing-custom-HTTP-Header-via-Apollo-Client/","webpackCompilationHash":"cb3b8dd0f56ad43f9bb4","result":{"data":{"markdownRemark":{"frontmatter":{"formattedDate":"2019/11/06","date":"November 6th, 2019","title":"Passing custom HTTP Header via Apollo Client","tags":["React","Apollo Client","C#","Programming Notes"],"slug":"Passing-custom-HTTP-Header-via-Apollo-Client/"},"html":"<p>Today I wanted to send along an array as a parameter with all queries from client to server. But I wanted to find a quick way to accomplish the task as changing all queries took a tremendous amount of time. One thing that came to my mind was making use of Apollo Client by adding a custom header every time a request is sent to the server. <code class=\"language-text\">Apollo Link</code> is a state management library for our client-side dashboard. It comes with something called <code class=\"language-text\">Link</code> which is more like the concept of middleware but in a much more flexible and elegant way. The cool thing about this feature is that they are chainable so that we can snap together and define the functionality to handle GraphQL requests by the client. So when we issue a GraphQL request, every single link is applied one after another. So it's the best place to add the custom header:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> addOrigin <span class=\"token operator\">=</span> <span class=\"token function\">setContext</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> IDs <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IDs\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    headers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>headers<span class=\"token punctuation\">,</span>\n      customHeaderName<span class=\"token punctuation\">:</span> IDs<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> links <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/* other links */</span> addOrigin<span class=\"token punctuation\">,</span> httpLink<span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  cache<span class=\"token punctuation\">,</span>\n  link<span class=\"token punctuation\">:</span> ApolloLink<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>links<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>On the backend we are using <code class=\"language-text\">graphql-dotnet</code> so all I had to do was to define a class and populate the header:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">services.AddGraphQL()\n    .AddUserContextBuilder(context =&gt; new GraphQLUserContext { User = context.User, Headers = context.Request.Headers})\n    .AddGraphTypes(ServiceLifetime.Scoped);\n\npublic class GraphQLUserContext\n{\n    public IHeaderDictionary Headers { get; set; }\n}</code></pre></div>\n<p>The code captures the headers and then make it available in resolve methods:</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">public class MyGraphType : ObjectGraphType\n{\n    public MyGraphType(MyService myService)\n    {\n        Field&lt;ListGraphType&lt;MyType&gt;&gt;(\n            &quot;items&quot;,\n            resolve: context =&gt;\n            {\n                var headers = (context.UserContext as dynamic).Headers as IHeaderDictionary;\n                var ids = headers?[&quot;customHeaderName&quot;];\n                if (string.IsNullOrEmpty(ids)) return myService.GetAllAsync();\n                var ids = (ids.Value).ToString().Split(&quot;, &quot;).Select(long.Parse);\n                return myService.GetAllAsync(ids);\n            });\n    }\n}</code></pre></div>"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"2019-11-06-Passing-custom-header-via-apollo-client"}}}