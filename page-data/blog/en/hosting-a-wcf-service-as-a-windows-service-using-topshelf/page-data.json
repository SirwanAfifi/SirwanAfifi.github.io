{"componentChunkName":"component---src-templates-blog-details-js","path":"/blog/en/hosting-a-wcf-service-as-a-windows-service-using-topshelf","result":{"data":{"markdownRemark":{"timeToRead":3,"frontmatter":{"date":"March 7th, 2019","title":"Hosting a WCF Service as a Windows Service Using Topshelf","tags":["C#","WCF"],"slug":"Hosting-WCF-Service/"},"html":"<p>You might be wondering why I am blogging about WCF. Is it still relevant? This is part of a legacy WCF project, and I am responsible for adding some functionalities to it, I like it though. By the way, it's been a long time since it went out of fashion, but many large enterprise applications still use it.</p>\n<p>As you know, WCF services need to run in a host process so when clients want to consume the services we need to make sure the services are alive. The host process needs to provide a host, and this host is responsible for setting up the services and listening for incoming messages then creating instances of the service and respond to the client by dispatching a call to the service class. As I mentioned in a legacy application we wanted to host our services as a Windows Service, this app had been using a Console application, but the problem with Console applications is that you need to make sure the app is open all the time. For example, if the server gets restarted you should manually open the app, you could say we should add this app as a startup process so whenever the system boots up this app is opened but we can achieve a better result by writing a Windows service instead. Windows services are a great way to run code in the background; this means that we donâ€™t need a Console Application to run the application. Once you installed the service it keeps running, we can control how to start the service for example when can set it to automatically started when the system boots or be configured when a user logs in. Both of these approaches are considered as two hosting options because they are self-hosted applications; it means that both are running inside a .NET process.</p>\n<h2>Installing Topshelf</h2>\n<p>Topshelf is an open source .NET Windows Service library, it makes the process of creating Windows services much easier for us so that we can only focus on the service functionality as opposed to setting up the boilerplate service code. To install TopShelf all we need to do is installing its NuGet package:</p>\n<pre><code>Install-Package Topshelf\n</code></pre>\n<p>The next step is wrapping your service functionality inside a class with two methods <code>Start</code> and <code>Stop</code> these methods are going to be used by TopShelf to start and stop the service:</p>\n<pre><code class=\"language-csharp\">public class MyService\n{\n    private ServiceHost usersHost;\n\n    public bool Start()\n    {\n\n        try\n        {\n            usersHost = new ServiceHost(typeof(UsersService.UsersService));\n\n            usersHost.Open();\n            Console.WriteLine(\"Service Running...\");\n            Console.WriteLine(\"Press a key to quit\");\n\n            return true;\n        }\n        catch (Exception ex)\n        {\n\n            return false;\n        }\n        finally\n        {\n            usersHost.Close();\n        }\n    }\n\n    public bool Stop()\n    {\n        usersHost.Close();\n\n        return true;\n    }\n}\n</code></pre>\n<p>The next step is adding this class to TopShelf for creating our Windows Service:</p>\n<pre><code class=\"language-csharp\">public class Program\n{\n    static void Main(string[] args)\n    {\n        HostFactory.Run(serviceConfig =>\n        {\n            serviceConfig.Service&#x3C;MyService>(serviceInstance =>\n            {\n                serviceInstance.ConstructUsing(() => new MyService());\n                serviceInstance.WhenStarted(execute => execute.Start());\n                serviceInstance.WhenStopped(execute => execute.Stop());\n            });\n\n            serviceConfig.SetServiceName(\"My Service\");\n            serviceConfig.SetDisplayName(\"My Service\");\n            serviceConfig.SetDescription(\"Hosting WCF services\");\n\n            serviceConfig.StartAutomatically();\n        });\n    }\n}\n</code></pre>\n<h2>Installing our service into Windows</h2>\n<ul>\n<li>Run Command Prompt as Admin</li>\n<li>cd into to bin\\Debug folder</li>\n<li>{AssebmlyName}.exe install</li>\n</ul>\n<h2>Adding NLog</h2>\n<p>We can add logging functionality to the mix using NLog, for doing so we first need to add the following package:</p>\n<pre><code>Install-Package Topshelf.NLog\n</code></pre>\n<p>The next step is to add the following configuration to <code>app.config</code> file:</p>\n<pre><code class=\"language-xml\">&#x3C;configSections>\n   &#x3C;section name=\"nlog\" type=\"NLog.Config.ConfigSectionHandler, NLog\"/>\n&#x3C;/configSections>\n\n&#x3C;nlog>\n    &#x3C;targets>\n      &#x3C;target name=\"consoleTarget\" type=\"Console\" />\n    &#x3C;/targets>\n    &#x3C;rules>\n      &#x3C;logger name=\"*\" minlevel=\"Debug\" writeTo=\"consoleTarget\" />\n    &#x3C;/rules>\n&#x3C;/nlog>\n</code></pre>\n<p>Then we need to register NLog service in the <code>Program.cs</code> file:</p>\n<pre><code class=\"language-csharp\">public class Program\n{\n    static void Main(string[] args)\n    {\n        HostFactory.Run(serviceConfig =>\n        {\n            serviceConfig.UseNLog();\n\n            // as before\n        });\n    }\n}\n</code></pre>\n<p>Now we can use the logger in our service:</p>\n<pre><code class=\"language-csharp\">public class MyService\n{\n    // our service declarations\n\n    private static readonly LogWriter _log = HostLogger.Get&#x3C;MyService>();\n\n     public bool Start()\n        {\n            try\n            {\n               _log.Info(\"Starting services\");\n\n</code></pre>"}},"pageContext":{"slug":"Hosting-WCF-Service/"}},"staticQueryHashes":[]}